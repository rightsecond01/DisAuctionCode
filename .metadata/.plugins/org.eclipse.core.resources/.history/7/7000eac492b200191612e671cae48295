package com.discodeaucion_ver03;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.DataInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.net.Socket;

import javax.swing.ImageIcon;

import com.util.ImageResize;

public class ImgReceiving extends Thread{
	
	int memberSize;
	String token;
	String user_id;
	
	public ImgReceiving(int memberSize,String token, String user_id) {
		this.memberSize = memberSize;
		this.token = token;
		this.user_id = user_id;
	}

	@Override
	public void run() {
		String saveFolderPath = "C:\\chat_temp\\" + user_id + "\\" + token.substring(0,10) + "\\";		
		String receiveFileName = null;
		Socket socket = null;
			try {
				///////디렉토리 생성//////////
				File saveFolder = new File(saveFolderPath);
				if(!saveFolder.exists()) {	
					saveFolder.mkdir();
				}
				/////////끝///////////////	
				for(int i=0;i<memberSize;i++) {
				socket = new Socket("127.0.0.1",60000);
				BufferedInputStream bis = new BufferedInputStream(socket.getInputStream());
				DataInputStream dis = new DataInputStream(bis);
				receiveFileName = dis.readUTF();
				String mem_id = receiveFileName.substring(0,receiveFileName.indexOf("_"));
				if(!mem_id.equals(user_id)) {
					File imgfile = new File(saveFolderPath +receiveFileName);
					FileOutputStream fos = new FileOutputStream(imgfile);
					BufferedOutputStream bos = new BufferedOutputStream(fos);
					int len;
					int r_data = 0;
					byte[] data = new byte[4096];
					while((len = dis.read(data)) != -1) {
						bos.write(data,0,len);
						bos.flush();
					}					
				}
				//////저장한 사진 리사이징//////
				resizeImage(saveFolderPath,receiveFileName);
			}
			} catch (IOException e) {
				e.printStackTrace();
			} 
	}

	private void resizeImage(String saveFolderPath,String receiveFileName) {
		//////폴더 없으면 폴더를 만드는 코드
		String resizeSaveFolderPath = saveFolderPath + "\\ImageResize\\";
		File resizeSaveFolder = new File(resizeSaveFolderPath);
		if(!resizeSaveFolder.exists()) {
			resizeSaveFolder.mkdir();
		}
		//////////끝//////////
		String filePath = saveFolderPath + receiveFileName;
		File resizeFile = new File(filePath);
		String tmpPath = resizeFile.getParent();
		String tmpFileName = resizeFile.getName();
		
		ImageIcon ic = ImageResize.resizeImage(filePath, 100, 100);
	}
}
